{% extends "base.html" %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/registration/password_reset_confirm.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="reset-container">
  <div class="reset-card">
    <div class="card-header">
      <div class="lock-icon"><i class="fas fa-lock"></i></div>
      <h1>Secure Password Reset</h1>
      <p>Create a strong new password</p>
    </div>

    <div class="divider"></div>

    <form method="post" class="reset-form" id="password-reset-form" autocomplete="off">
      {% csrf_token %}
      {% if validlink %}

        <!-- New Password Field -->
        <div class="input-group">
          <label for="{{ form.new_password1.id_for_label }}" class="input-label">
            New password
          </label>
          <div class="password-field">
            {{ form.new_password1 }}
            <button type="button" class="toggle-password" aria-label="Show password" tabindex="-1">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          {% for err in form.new_password1.errors %}
            <div class="error-message">{{ err }}</div>
          {% endfor %}

          <!-- Password Strength Meter -->
          <div class="strength-container">
            <div class="strength-meter">
              <div class="strength-fill" id="strength-fill"></div>
            </div>
            <div class="strength-labels">
              <span>Weak</span>
              <span>Medium</span>
              <span>Strong</span>
            </div>
          </div>
        </div>

        <!-- Confirm Password Field -->
        <div class="input-group">
          <label for="{{ form.new_password2.id_for_label }}" class="input-label">
            Confirm new password
          </label>
          <div class="password-field">
            {{ form.new_password2 }}
            <button type="button" class="toggle-password" aria-label="Show password" tabindex="-1">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          {% for err in form.new_password2.errors %}
            <div class="error-message">{{ err }}</div>
          {% endfor %}
        </div>

        <!-- Password Requirements -->
        <div class="password-requirements">
          <p class="requirements-title">Your password must contain:</p>
          <ul class="requirement-list">
            <li class="requirement" id="length-req">
              <span class="status-icon"><i class="far fa-circle"></i></span>
              At least 8 characters
            </li>
            <li class="requirement" id="uppercase-req">
              <span class="status-icon"><i class="far fa-circle"></i></span>
              An uppercase letter
            </li>
            <li class="requirement" id="number-req">
              <span class="status-icon"><i class="far fa-circle"></i></span>
              A number
            </li>
            <li class="requirement" id="special-req">
              <span class="status-icon"><i class="far fa-circle"></i></span>
              A special character
            </li>
          </ul>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="reset-button" id="submit-btn">
          <i class="fas fa-key"></i>
          <span class="btn-text">Reset Password</span>
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </button>

      {% else %}
        <!-- Invalid Link Message -->
        <div class="invalid-link-container">
          <svg class="warning-icon" viewBox="0 0 24 24">
            <path d="M12,2L1,21H23M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"/>
          </svg>
          <p class="invalid-link">
            This link is invalid or has expired. Please request a new password reset.
          </p>
          <a href="{% url 'accounts:password_reset' %}" class="reset-button">
            Request New Link
          </a>
        </div>
      {% endif %}
    </form>

    <!-- Footer Note -->
    <p class="footer-note">
      Remember your password?
      <a href="{% url 'accounts:patient_login' %}">Sign in here</a>
    </p>
  </div>
</div>

<script src="{% static 'js/registration/password_reset_confirm.js' %}"></script>
{% endblock content %}
