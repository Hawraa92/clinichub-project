{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load tz %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/appointments/secretary_dashboard.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Sidebar Navigation">
    <div class="brand-container">
      <div class="clinic-logo">
        <i class="bi bi-heart-pulse"></i>
      </div>
      <div class="brand-text">
        <h3>Clinic Panel</h3>
        <p>Secretary Dashboard</p>
      </div>
    </div>
    
    <nav class="nav-menu" role="navigation">
      <a href="{% url 'appointments:secretary_dashboard' %}" 
         class="nav-item{% if request.resolver_match.url_name == 'secretary_dashboard' %} active{% endif %}">
        <i class="bi bi-house-door" aria-hidden="true"></i> 
        <span>Dashboard</span>
      </a>

      <a href="{% url 'patient:create_patient' %}" 
         class="nav-item{% if request.resolver_match.url_name == 'create_patient' %} active{% endif %}">
        <i class="bi bi-person-plus" aria-hidden="true"></i> 
        <span>New Patient</span>
      </a>

      {# قائمة المرضى الذين أضفتهم أنا #}
      <a href="{% url 'patient:list' %}?added_by=me"
         class="nav-item{% if request.resolver_match.app_name == 'patient' and request.resolver_match.url_name == 'list' and request.GET.added_by == 'me' %} active{% endif %}">
        <i class="bi bi-people" aria-hidden="true"></i>
        <span>List of Patients</span>
      </a>

      <a href="{% url 'appointments:create_appointment' %}" 
         class="nav-item{% if request.resolver_match.url_name == 'create_appointment' %} active{% endif %}">
        <i class="bi bi-calendar-plus" aria-hidden="true"></i> 
        <span>Book Appointment</span>
      </a>

      <a href="{% url 'appointments:appointment_list' %}" 
         class="nav-item{% if request.resolver_match.url_name == 'appointment_list' %} active{% endif %}">
        <i class="bi bi-list-check" aria-hidden="true"></i> 
        <span>Appointments</span>
      </a>

      <a href="{% url 'appointments:queue_display' %}" 
         class="nav-item{% if request.resolver_match.url_name == 'queue_display' %} active{% endif %}">
        <i class="bi bi-people" aria-hidden="true"></i> 
        <span>Queue</span>
      </a>

      {# ==== الزر الجديد: التقارير ==== #}
      <a href="{% url 'appointments:secretary_reports' %}" 
         class="nav-item{% if request.resolver_match.url_name == 'secretary_reports' %} active{% endif %}">
        <i class="bi bi-graph-up" aria-hidden="true"></i>
        <span>Reports</span>
      </a>
      {# ================================ #}

      <a href="{% url 'appointments:secretary_settings' %}" 
         class="nav-item{% if request.resolver_match.url_name == 'secretary_settings' %} active{% endif %}">
        <i class="bi bi-gear" aria-hidden="true"></i> 
        <span>Settings</span>
      </a>
    </nav>
    
    <div class="logout-container">
      <a href="{% url 'accounts:logout' %}" class="nav-item">
        <i class="bi bi-box-arrow-right" aria-hidden="true"></i> 
        <span>Logout</span>
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content" id="main">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="notification-container">
        <div class="notification-bell"
             id="notificationBell"
             role="button"
             tabindex="0"
             aria-haspopup="true"
             aria-expanded="false"
             aria-label="Show new booking requests"
             data-notification-url="{% url 'appointments:new_booking_requests_api' %}"
             data-csrf-token="{{ csrf_token }}">
          <i class="bi bi-bell-fill" aria-hidden="true"></i>
          <span class="notification-count" id="notificationCount">0</span>
        </div>
        <div class="notification-dropdown"
             id="notificationDropdown"
             role="region"
             aria-label="Booking Requests"
             aria-live="polite">
          <div class="notification-dropdown-header">Notifications</div>
          <div class="notification-list" id="notificationList">
            <div class="no-notifications">No new booking requests.</div>
          </div>
        </div>
      </div>
      <div class="user-info">
        <span>Welcome, {{ request.user.first_name|default:request.user.username }}</span>
        <div class="user-avatar">
          <i class="bi bi-person-circle"></i>
        </div>
      </div>
    </div>

    <!-- Welcome Section -->
    <section class="welcome-section" aria-labelledby="welcomeHeading">
      <div class="welcome-card">
        <div class="welcome-text">
          <h2 id="welcomeHeading">Welcome, {{ request.user.first_name|default:request.user.username }}!</h2>
          <p class="inspiration">
            "Caring for others starts with caring for yourself."
            <i class="bi bi-heart-pulse-fill" aria-hidden="true"></i>
          </p>
        </div>
        <div class="datetime-card" aria-label="Current time and date">
          <div class="clock-icon">
            <i class="bi bi-clock" aria-hidden="true"></i>
          </div>
          <div class="datetime-info">
            <div id="digital-clock" class="clock" aria-live="polite"></div>
            <div id="digital-date" class="date" aria-live="polite"></div>
          </div>
        </div>
      </div>
      <div class="quick-actions" aria-label="Quick actions">
        <a href="{% url 'patient:create_patient' %}" class="action-btn">
          <i class="bi bi-person-plus" aria-hidden="true"></i>
          <span>New Patient</span>
        </a>
        <a href="{% url 'appointments:create_appointment' %}" class="action-btn">
          <i class="bi bi-calendar-plus" aria-hidden="true"></i>
          <span>Book Appointment</span>
        </a>
        <a href="{% url 'appointments:appointment_list' %}" class="action-btn">
          <i class="bi bi-list-check" aria-hidden="true"></i>
          <span>All Appointments</span>
        </a>
        <a href="{% url 'patient:list' %}?added_by=me" class="action-btn">
          <i class="bi bi-people" aria-hidden="true"></i>
          <span>List of Patients</span>
        </a>
      </div>
    </section>

    <!-- Stats Cards -->
    <section class="stats-grid" aria-label="Today statistics">
      <div class="stat-card patients">
        <div class="card-icon">
          <i class="bi bi-people-fill" aria-hidden="true"></i>
        </div>
        <div class="card-content">
          <h3>Total Patients</h3>
          <p>{{ stats.total_patients }}</p>
        </div>
      </div>
      
      <div class="stat-card appointments">
        <div class="card-icon">
          <i class="bi bi-calendar-check" aria-hidden="true"></i>
        </div>
        <div class="card-content">
          <h3>Today's Appointments</h3>
          <p>{{ stats.appointments_today }}</p>
        </div>
      </div>
      
      <div class="stat-card new-patients">
        <div class="card-icon">
          <i class="bi bi-person-plus" aria-hidden="true"></i>
        </div>
        <div class="card-content">
          <h3>New Patients Today</h3>
          <p>{{ stats.new_patients_today }}</p>
        </div>
      </div>
      
      <div class="stat-card revenue">
        <div class="card-icon">
          <i class="bi bi-cash-stack" aria-hidden="true"></i>
        </div>
        <div class="card-content">
          <h3>Today's Revenue</h3>
          <p>{{ stats.revenue_today_iqd|intcomma }} IQD</p>
        </div>
      </div>
    </section>

    <!-- Chart Section -->
    <section class="chart-section" aria-labelledby="weeklyChartHeading">
      <div class="section-header">
        <h2 id="weeklyChartHeading">
          <i class="bi bi-bar-chart-line" aria-hidden="true"></i> Weekly Patients Overview
        </h2>
      </div>
      <div class="chart-container">
        <canvas id="patientsWeekChart" role="img" aria-label="Weekly patients bar chart"></canvas>
        <script id="chart-data" type="application/json">{{ chart_data_json|safe }}</script>
        <noscript><p class="text-muted small">Enable JavaScript to see the weekly chart.</p></noscript>
      </div>
    </section>

    <!-- Today's Appointments -->
    <section class="appointments-section" aria-labelledby="todayApptsHeading">
      <div class="section-header">
        <h2 id="todayApptsHeading">
          <i class="bi bi-list-task" aria-hidden="true"></i> Today's Appointments
        </h2>
      </div>
      <div class="appointments-list">
        {% if today_appointments %}
          {% for appt in today_appointments %}
            <div class="appointment-item">
              <div class="appt-time">
                {{ appt.scheduled_time|time:"H:i" }}
              </div>
              <div class="appt-info">
                <div class="appt-icon">
                  <i class="bi bi-person-circle" aria-hidden="true"></i>
                </div>
                <div class="appt-details">
                  <span class="appt-patient">{{ appt.patient.full_name }}</span>
                  <span class="appt-doctor">
                    with Dr. {{ appt.doctor.user.get_full_name|default:appt.doctor.user.username }}
                  </span>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-appointments">
            <i class="bi bi-calendar-x"></i>
            <p>No appointments for today</p>
          </div>
        {% endif %}
      </div>
    </section>
  </main>
</div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{% static 'js/appointments/secretary_dashboard.js' %}"></script>
{% endblock %}
