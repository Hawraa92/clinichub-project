{% extends "base.html" %}
{% load static humanize tz %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/appointments/secretary_reports.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="reports-wrapper container py-3">

  <!-- Header -->
  <div class="reports-header d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1">Secretary Reports</h2>
      <div class="text-muted small">
        Period:
        <span class="badge bg-light text-dark">{{ period|title }}</span>
        <span class="ms-2">
          {{ start|date:"Y-m-d" }} → {{ end|date:"Y-m-d" }}
        </span>
      </div>
    </div>
    <a class="btn btn-outline-secondary" href="{% url 'appointments:secretary_dashboard' %}">
      <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
    </a>
  </div>

  <!-- Filters -->
  <form class="row g-2 mb-3 align-items-end" method="get" action="">
    <div class="col-sm-3">
      <label for="periodSelect" class="form-label">Period</label>
      <select name="period" class="form-select" id="periodSelect" onchange="onPeriodChange(this)">
        <option value="day"   {% if period == 'day' %}selected{% endif %}>Today</option>
        <option value="week"  {% if period == 'week' %}selected{% endif %}>This Week</option>
        <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
        <option value="custom"{% if period == 'custom' %}selected{% endif %}>Custom</option>
      </select>
    </div>
    <div class="col-sm-3">
      <label for="startInput" class="form-label">Start</label>
      <input type="date" name="start" value="{{ start|date:'Y-m-d' }}" class="form-control" id="startInput">
    </div>
    <div class="col-sm-3">
      <label for="endInput" class="form-label">End</label>
      <input type="date" name="end" value="{{ end|date:'Y-m-d' }}" class="form-control" id="endInput">
    </div>
    <div class="col-sm-3 d-flex gap-2">
      <button class="btn btn-primary flex-fill" type="submit">
        <i class="bi bi-funnel me-1"></i> Apply
      </button>
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-download me-1"></i> Export
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item"
               href="{% url 'appointments:reports_export' %}?format=csv&period={{ period }}&start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}">
              <i class="bi bi-filetype-csv me-2"></i> CSV
            </a>
          </li>
          <li>
            <a class="dropdown-item"
               href="{% url 'appointments:reports_export' %}?format=xlsx&period={{ period }}&start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}">
              <i class="bi bi-file-earmark-excel me-2"></i> XLSX
            </a>
          </li>
        </ul>
      </div>
    </div>
  </form>

  <!-- Summary cards -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-2">
      <div class="kpi-card h-100">
        <div class="kpi-label">Total</div>
        <div class="kpi-value">{{ summary.total }}</div>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="kpi-card h-100">
        <div class="kpi-label">Completed</div>
        <div class="kpi-value text-success">{{ summary.completed }}</div>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="kpi-card h-100">
        <div class="kpi-label">Cancelled</div>
        <div class="kpi-value text-danger">{{ summary.cancelled }}</div>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="kpi-card h-100">
        <div class="kpi-label">Pending</div>
        <div class="kpi-value text-warning">{{ summary.pending }}</div>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="kpi-card h-100">
        <div class="kpi-label">Revenue (IQD)</div>
        <div class="kpi-value">{{ summary.revenue|intcomma }}</div>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="kpi-card h-100">
        <div class="kpi-label">New Patients</div>
        <div class="kpi-value">{{ summary.new_patients }}</div>
      </div>
    </div>
  </div>

  <!-- Daily trend (optional chart) -->
  <div class="card mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <span><i class="bi bi-graph-up-arrow me-2"></i> Daily Trend</span>
      <small class="text-muted">Appointments & Revenue</small>
    </div>
    <div class="card-body">
      <div class="chart-container">
        <canvas id="dailyChart" role="img" aria-label="Daily appointments and revenue"></canvas>
      </div>
      {# آمن لإرسال JSON إلى JS #}
      {{ daily|json_script:"daily-data" }}
    </div>
  </div>

  <!-- Top doctors -->
  <div class="card mb-3">
    <div class="card-header"><i class="bi bi-award me-2"></i> Top Doctors</div>
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Doctor</th>
            <th class="text-end">Appointments</th>
            <th class="text-end">Revenue</th>
          </tr>
        </thead>
        <tbody>
        {% for d in top_doctors %}
          <tr>
            <td>{{ d.doctor__user__first_name }} {{ d.doctor__user__last_name }}</td>
            <td class="text-end">{{ d.count }}</td>
            <td class="text-end">{{ d.rev|default:0|intcomma }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="text-muted text-center py-3">No data</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Appointments table -->
  <div class="card">
    <div class="card-header"><i class="bi bi-list-check me-2"></i> Appointments ({{ start|date:"Y-m-d" }} → {{ end|date:"Y-m-d" }})</div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Time</th>
            <th>Patient</th>
            <th>Doctor</th>
            <th>Status</th>
            <th class="text-end">IQD</th>
          </tr>
        </thead>
        <tbody>
        {% for a in appointments %}
          {% with dt=a.scheduled_time|localtime %}
          <tr>
            <td>{{ a.id }}</td>
            <td>{{ dt|date:"Y-m-d" }}</td>
            <td>{{ dt|date:"H:i" }}</td>
            <td>{{ a.patient.full_name }}</td>
            <td>Dr. {{ a.doctor.user.get_full_name|default:a.doctor.user.username }}</td>
            <td>
              <span class="status-pill status-{{ a.get_status_display|slugify }}">
                {{ a.get_status_display }}
              </span>
            </td>
            <td class="text-end">{{ a.iqd_amount|default:0|intcomma }}</td>
          </tr>
          {% endwith %}
        {% empty %}
          <tr><td colspan="7" class="text-muted text-center py-3">No appointments in this period.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function onPeriodChange(sel){
    const start = document.getElementById('startInput');
    const end = document.getElementById('endInput');
    if(sel.value === 'custom'){
      start.removeAttribute('disabled'); end.removeAttribute('disabled');
    }else{
      start.setAttribute('disabled','disabled'); end.setAttribute('disabled','disabled');
    }
  }
  // تزامن حالة الحقول عند الفتح
  document.addEventListener('DOMContentLoaded', function(){
    onPeriodChange(document.getElementById('periodSelect'));

    // رسم المخطط اليومي (إن وُجدت بيانات)
    const dataScript = document.getElementById('daily-data');
    if (!dataScript) return;
    const daily = JSON.parse(dataScript.textContent || "[]");
    if (!Array.isArray(daily) || daily.length === 0) return;

    const labels = daily.map(r => r.day);          // قد تكون على شكل "YYYY-MM-DD"
    const counts = daily.map(r => r.count);
    const revenue = daily.map(r => r.revenue);

    const ctx = document.getElementById('dailyChart');
    if (!ctx) return;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Appointments', data: counts, yAxisID: 'y' },
          { label: 'Revenue (IQD)', data: revenue, type: 'line', yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Appointments' } },
          y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Revenue (IQD)' }, grid: { drawOnChartArea: false } }
        },
        plugins: { legend: { position: 'top' } }
      }
    });
  });
</script>
{% endblock %}
