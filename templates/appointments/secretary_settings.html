{% extends "base.html" %}
{% load static widget_tweaks %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/appointments/secretary_settings.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
  .settings-wrapper {
    max-width: 1200px;
  }
  
  .settings-card {
    border: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .settings-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
  }
  
  .card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
    padding: 1.25rem 1.5rem;
  }
  
  .password-strength-container {
    margin-top: 0.5rem;
  }
  
  .password-strength {
    font-size: 0.75rem;
    font-weight: 600;
    min-height: 1rem;
    transition: all 0.3s ease;
  }
  
  .password-strength[data-level="0"] { color: #6c757d; }
  .password-strength[data-level="1"] { color: #dc3545; }
  .password-strength[data-level="2"] { color: #fd7e14; }
  .password-strength[data-level="3"] { color: #ffc107; }
  .password-strength[data-level="4"] { color: #20c997; }
  .password-strength[data-level="5"] { color: #198754; }
  
  .password-criteria {
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }
  
  .criteria-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.25rem;
    transition: all 0.3s ease;
  }
  
  .criteria-item.valid {
    color: #198754;
  }
  
  .criteria-item.invalid {
    color: #6c757d;
  }
  
  .criteria-icon {
    margin-right: 0.5rem;
    font-size: 0.9em;
  }
  
  .password-match {
    font-size: 0.8rem;
    margin-top: 0.25rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .password-match.valid {
    color: #198754;
  }
  
  .password-match.invalid {
    color: #dc3545;
  }
  
  .form-control {
    border-radius: 8px;
    border: 1px solid #ced4da;
    transition: all 0.3s ease;
    padding: 0.75rem 1rem;
  }
  
  .form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
    border-color: #86b7fe;
  }
  
  .btn {
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    border: none;
  }
  
  .btn-warning {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    border: none;
    color: #000;
  }
  
  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .loading-spinner {
    display: none;
    margin-left: 0.5rem;
  }
  
  .btn.loading .loading-spinner {
    display: inline-block;
  }
  
  .alert {
    border: none;
    border-radius: 8px;
    border-left: 4px solid;
  }
  
  .alert-success {
    border-left-color: #198754;
    background: linear-gradient(135deg, #d1e7dd 0%, #badbcc 100%);
  }
  
  .alert-danger {
    border-left-color: #dc3545;
    background: linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%);
  }
  
  .profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    margin: 0 auto 1.5rem;
  }
  
  .section-title {
    position: relative;
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
  }
  
  .section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 50px;
    height: 3px;
    background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%);
    border-radius: 2px;
  }
  
  .floating-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1060;
    min-width: 300px;
    animation: slideInRight 0.5s ease;
  }
  
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  .form-group {
    position: relative;
    margin-bottom: 1.5rem;
  }
  
  .form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #495057;
  }
  
  .input-group-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    z-index: 5;
  }
  
  .input-with-icon {
    padding-right: 2.5rem !important;
  }
  
  @media (max-width: 768px) {
    .settings-wrapper {
      padding: 1rem;
    }
    
    .btn {
      width: 100%;
      margin-bottom: 1rem;
    }
    
    .floating-alert {
      left: 10px;
      right: 10px;
      min-width: auto;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="settings-wrapper container-fluid py-4">

  {# Floating success message #}
  <div id="floatingAlert" class="floating-alert alert alert-success d-none" role="alert">
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill me-2"></i>
      <span id="alertMessage"></span>
      <button type="button" class="btn-close ms-auto" onclick="hideAlert()"></button>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <div class="profile-avatar">
            <i class="bi bi-person-fill"></i>
          </div>
          <div>
            <h1 class="text-primary fw-bold mb-1">Account Settings</h1>
            <p class="text-muted mb-0">Manage your profile and security preferences</p>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="window.location.reload()">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
          </button>
          <button class="btn btn-outline-secondary" onclick="showHelpModal()">
            <i class="bi bi-question-circle me-1"></i> Help
          </button>
        </div>
      </div>
    </div>
  </div>

  {% if messages %}
    <div class="row mb-4">
      <div class="col-12">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show animate__animated animate__fadeIn" role="alert">
            <div class="d-flex align-items-center">
              <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% else %}bi-exclamation-triangle-fill{% endif %} me-2"></i>
              <span>{{ message }}</span>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="row g-4">

    {# ---------------- Profile Form ---------------- #}
    <div class="col-xl-6">
      <div class="card shadow-sm h-100 settings-card animate__animated animate__fadeInLeft">
        <div class="card-header">
          <h2 class="h5 mb-0 d-flex align-items-center">
            <i class="bi bi-person-gear me-2 text-primary"></i>
            <span>Profile Information</span>
          </h2>
        </div>
        <div class="card-body p-4">
          <form method="post" id="profileForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="form_type" value="profile">

            {% if profile_form.non_field_errors %}
              <div class="alert alert-danger py-2 mb-4 animate__animated animate__shakeX" role="alert" aria-live="assertive">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ profile_form.non_field_errors }}
              </div>
            {% endif %}

            {% for field in profile_form %}
              <div class="form-group">
                <label class="form-label" for="{{ field.id_for_label }}">
                  {{ field.label }}
                  {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                
                <div class="position-relative">
                  {% if field.errors %}
                    {% render_field field class+="form-control is-invalid input-with-icon" %}
                    <div class="input-group-icon text-danger">
                      <i class="bi bi-exclamation-circle-fill"></i>
                    </div>
                  {% else %}
                    {% render_field field class+="form-control input-with-icon" %}
                    <div class="input-group-icon">
                      <i class="bi bi-{% if field.name == 'username' %}person{% elif field.name == 'email' %}envelope{% else %}input-cursor-text{% endif %}"></i>
                    </div>
                  {% endif %}
                </div>

                {% if field.errors %}
                  <div class="invalid-feedback d-block mt-2">
                    <ul class="mb-0 ps-3">
                      {% for err in field.errors %}
                        <li>{{ err }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
                
                {% if field.help_text %}
                  <small class="form-text text-muted mt-1 d-block">
                    <i class="bi bi-info-circle me-1"></i>{{ field.help_text }}
                  </small>
                {% endif %}
              </div>
            {% endfor %}

            <div class="d-flex gap-2 flex-wrap">
              <button type="submit" class="btn btn-primary px-4" id="profileSubmitBtn">
                <i class="bi bi-save me-1"></i> Save Changes
                <div class="loading-spinner spinner-border spinner-border-sm" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </button>
              <button type="reset" class="btn btn-outline-secondary px-4">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {# ---------------- Password Form ---------------- #}
    <div class="col-xl-6">
      <div class="card shadow-sm h-100 settings-card animate__animated animate__fadeInRight">
        <div class="card-header">
          <h2 class="h5 mb-0 d-flex align-items-center">
            <i class="bi bi-shield-lock me-2 text-warning"></i>
            <span>Security Settings</span>
          </h2>
        </div>
        <div class="card-body p-4">
          <form method="post" id="passwordForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="form_type" value="password">

            {% if password_form.non_field_errors %}
              <div class="alert alert-danger py-2 mb-4 animate__animated animate__shakeX" role="alert" aria-live="assertive">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ password_form.non_field_errors }}
              </div>
            {% endif %}

            {# current_password #}
            <div class="form-group">
              <label class="form-label" for="{{ password_form.current_password.id_for_label }}">
                {{ password_form.current_password.label }}
              </label>
              <div class="position-relative">
                {% if password_form.current_password.errors %}
                  {% render_field password_form.current_password class+="form-control is-invalid input-with-icon" autocomplete="current-password" %}
                  <div class="input-group-icon text-danger">
                    <i class="bi bi-exclamation-circle-fill"></i>
                  </div>
                {% else %}
                  {% render_field password_form.current_password class+="form-control input-with-icon" autocomplete="current-password" %}
                  <div class="input-group-icon">
                    <i class="bi bi-lock-fill"></i>
                  </div>
                {% endif %}
              </div>
              {% if password_form.current_password.errors %}
                <div class="invalid-feedback d-block mt-2">
                  {{ password_form.current_password.errors }}
                </div>
              {% endif %}
            </div>

            {# new_password #}
            <div class="form-group">
              <label class="form-label" for="{{ password_form.new_password.id_for_label }}">
                {{ password_form.new_password.label }}
              </label>
              <div class="position-relative">
                {% if password_form.new_password.errors %}
                  {% render_field password_form.new_password class+="form-control is-invalid input-with-icon" autocomplete="new-password" aria-describedby="passwordStrength passwordCriteria" %}
                  <div class="input-group-icon text-danger">
                    <i class="bi bi-exclamation-circle-fill"></i>
                  </div>
                {% else %}
                  {% render_field password_form.new_password class+="form-control input-with-icon" autocomplete="new-password" aria-describedby="passwordStrength passwordCriteria" %}
                  <div class="input-group-icon">
                    <i class="bi bi-key-fill"></i>
                  </div>
                {% endif %}
              </div>

              <div class="password-strength-container">
                <div id="passwordStrength" class="password-strength" aria-live="polite"></div>
                <div id="passwordCriteria" class="password-criteria">
                  <div class="criteria-item invalid" id="criteria-length">
                    <i class="bi bi-x-circle criteria-icon"></i>
                    <span>At least 8 characters</span>
                  </div>
                  <div class="criteria-item invalid" id="criteria-uppercase">
                    <i class="bi bi-x-circle criteria-icon"></i>
                    <span>One uppercase letter</span>
                  </div>
                  <div class="criteria-item invalid" id="criteria-lowercase">
                    <i class="bi bi-x-circle criteria-icon"></i>
                    <span>One lowercase letter</span>
                  </div>
                  <div class="criteria-item invalid" id="criteria-number">
                    <i class="bi bi-x-circle criteria-icon"></i>
                    <span>One number</span>
                  </div>
                  <div class="criteria-item invalid" id="criteria-special">
                    <i class="bi bi-x-circle criteria-icon"></i>
                    <span>One special character</span>
                  </div>
                </div>
              </div>
            </div>

            {# confirm_new_password #}
            <div class="form-group">
              <label class="form-label" for="{{ password_form.confirm_new_password.id_for_label }}">
                {{ password_form.confirm_new_password.label }}
              </label>
              <div class="position-relative">
                {% if password_form.confirm_new_password.errors %}
                  {% render_field password_form.confirm_new_password class+="form-control is-invalid input-with-icon" autocomplete="new-password" %}
                  <div class="input-group-icon text-danger">
                    <i class="bi bi-exclamation-circle-fill"></i>
                  </div>
                {% else %}
                  {% render_field password_form.confirm_new_password class+="form-control input-with-icon" autocomplete="new-password" %}
                  <div class="input-group-icon">
                    <i class="bi bi-key-fill"></i>
                  </div>
                {% endif %}
              </div>
              <div id="passwordMatch" class="password-match"></div>
              {% if password_form.confirm_new_password.errors %}
                <div class="invalid-feedback d-block mt-2">
                  {{ password_form.confirm_new_password.errors }}
                </div>
              {% endif %}
            </div>

            <div class="d-flex gap-2 flex-wrap">
              <button type="submit" class="btn btn-warning px-4" id="passwordSubmitBtn">
                <i class="bi bi-key-fill me-1"></i> Update Password
                <div class="loading-spinner spinner-border spinner-border-sm" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </button>
              <button type="reset" class="btn btn-outline-secondary px-4" id="resetPasswordBtn">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Clear
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div><!-- /row -->
</div>

{# Help Modal #}
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="helpModalLabel">
          <i class="bi bi-question-circle me-2"></i>Account Settings Help
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Profile Information</h6>
                <ul class="list-unstyled">
              <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Keep your contact information updated</li>
              <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Use a valid email address</li>
              <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Required fields are marked with *</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6 class="text-warning mb-3">Password Security</h6>
            <ul class="list-unstyled">
              <li class="mb-2"><i class="bi bi-shield-check text-success me-2"></i>Use a strong, unique password</li>
              <li class="mb-2"><i class="bi bi-shield-check text-success me-2"></i>Include numbers and special characters</li>
              <li class="mb-2"><i class="bi bi-shield-check text-success me-2"></i>Don't reuse old passwords</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/appointments/secretary_settings.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js"></script>
<script>
// Enhanced Password Strength Meter with zxcvbn
(function() {
  const newPasswordInput = document.querySelector('input[name="new_password"]');
  const confirmPasswordInput = document.querySelector('input[name="confirm_new_password"]');
  const strengthBox = document.getElementById('passwordStrength');
  const matchBox = document.getElementById('passwordMatch');
  
  if (!newPasswordInput || !strengthBox) return;

  // Password criteria elements
  const criteria = {
    length: document.getElementById('criteria-length'),
    uppercase: document.getElementById('criteria-uppercase'),
    lowercase: document.getElementById('criteria-lowercase'),
    number: document.getElementById('criteria-number'),
    special: document.getElementById('criteria-special')
  };

  function evaluatePassword(password) {
    if (!password) {
      return { score: 0, feedback: '' };
    }
    
    // Basic criteria checking
    const hasLength = password.length >= 8;
    const hasUppercase = /[A-Z]/.test(password);
    const hasLowercase = /[a-z]/.test(password);
    const hasNumber = /\d/.test(password);
    const hasSpecial = /[^A-Za-z0-9]/.test(password);
    
    // Update criteria indicators
    updateCriteria(criteria.length, hasLength);
    updateCriteria(criteria.uppercase, hasUppercase);
    updateCriteria(criteria.lowercase, hasLowercase);
    updateCriteria(criteria.number, hasNumber);
    updateCriteria(criteria.special, hasSpecial);
    
    // Calculate basic score
    let basicScore = [hasLength, hasUppercase, hasLowercase, hasNumber, hasSpecial]
      .filter(Boolean).length;
    
    // Use zxcvbn for advanced strength analysis
    const zxcvbnResult = zxcvbn(password);
    const advancedScore = zxcvbnResult.score;
    
    // Combine scores (favor zxcvbn but consider basic requirements)
    const finalScore = Math.max(basicScore, advancedScore + 1);
    
    const labels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong', 'Excellent'];
    const feedbacks = [
      'Easy to crack',
      'Vulnerable to attacks',
      'Could be stronger',
      'Fairly secure',
      'Very secure',
      'Extremely secure'
    ];
    
    return {
      score: Math.min(finalScore, 5),
      label: labels[Math.min(finalScore, 5)],
      feedback: feedbacks[Math.min(finalScore, 5)],
      crackTime: zxcvbnResult.crack_times_display.offline_slow_hashing_1e4_per_second
    };
  }

  function updateCriteria(element, isValid) {
    if (isValid) {
      element.classList.remove('invalid');
      element.classList.add('valid');
      element.querySelector('.bi').className = 'bi bi-check-circle-fill criteria-icon text-success';
    } else {
      element.classList.remove('valid');
      element.classList.add('invalid');
      element.querySelector('.bi').className = 'bi bi-x-circle criteria-icon text-danger';
    }
  }

  function checkPasswordMatch() {
    if (!confirmPasswordInput || !matchBox) return;
    
    const password = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (!confirmPassword) {
      matchBox.textContent = '';
      matchBox.className = 'password-match';
      return;
    }
    
    if (password === confirmPassword) {
      matchBox.textContent = '✓ Passwords match';
      matchBox.className = 'password-match valid';
    } else {
      matchBox.textContent = '✗ Passwords do not match';
      matchBox.className = 'password-match invalid';
    }
  }

  newPasswordInput.addEventListener('input', function() {
    const { score, label, feedback, crackTime } = evaluatePassword(this.value);
    strengthBox.dataset.level = score;
    strengthBox.innerHTML = `
      <strong>Strength:</strong> ${label} 
      <small class="text-muted">- ${feedback}</small>
      ${crackTime ? `<br><small>Estimated crack time: ${crackTime}</small>` : ''}
    `;
    checkPasswordMatch();
  });

  if (confirmPasswordInput) {
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
  }

  // Form submission handling
  const profileForm = document.getElementById('profileForm');
  const passwordForm = document.getElementById('passwordForm');
  const profileSubmitBtn = document.getElementById('profileSubmitBtn');
  const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');

  if (profileForm && profileSubmitBtn) {
    profileForm.addEventListener('submit', function() {
      profileSubmitBtn.classList.add('loading');
    });
  }

  if (passwordForm && passwordSubmitBtn) {
    passwordForm.addEventListener('submit', function(e) {
      const password = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      if (password !== confirmPassword) {
        e.preventDefault();
        showAlert('Passwords do not match!', 'danger');
        confirmPasswordInput.focus();
        return;
      }
      
      const { score } = evaluatePassword(password);
      if (score < 2) {
        if (!confirm('Your password is weak. Are you sure you want to continue?')) {
          e.preventDefault();
          return;
        }
      }
      
      passwordSubmitBtn.classList.add('loading');
    });
  }

  // Reset password form
  const resetPasswordBtn = document.getElementById('resetPasswordBtn');
  if (resetPasswordBtn) {
    resetPasswordBtn.addEventListener('click', function() {
      strengthBox.textContent = '';
      strengthBox.dataset.level = '0';
      matchBox.textContent = '';
      matchBox.className = 'password-match';
      
      // Reset criteria indicators
      Object.values(criteria).forEach(criterion => {
        criterion.classList.remove('valid');
        criterion.classList.add('invalid');
        criterion.querySelector('.bi').className = 'bi bi-x-circle criteria-icon text-danger';
      });
    });
  }
})();

// Alert functions
function showAlert(message, type = 'success') {
  const alert = document.getElementById('floatingAlert');
  const alertMessage = document.getElementById('alertMessage');
  
  if (alert && alertMessage) {
    alert.className = `floating-alert alert alert-${type} animate__animated animate__fadeInRight`;
    alertMessage.textContent = message;
    alert.classList.remove('d-none');
    
    // Auto hide after 5 seconds
    setTimeout(hideAlert, 5000);
  }
}

function hideAlert() {
  const alert = document.getElementById('floatingAlert');
  if (alert) {
    alert.classList.add('animate__fadeOutRight');
    setTimeout(() => {
      alert.classList.add('d-none');
      alert.classList.remove('animate__fadeOutRight');
    }, 500);
  }
}

// Help modal
function showHelpModal() {
  const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
  helpModal.show();
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  const tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Remove loading states when page fully loads
  const loadingButtons = document.querySelectorAll('.btn.loading');
  loadingButtons.forEach(btn => btn.classList.remove('loading'));
});
</script>
{% endblock %}